<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quizet Web API - Playable Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Quizet! Challenge Yourself</h1>
        
        <p class="text-gray-600 mb-4">Select a subject to begin the quiz:</p>
        
        <div id="subject-buttons" class="flex flex-wrap gap-3 mb-8">
            <!-- Subject buttons will be loaded here -->
        </div>

        <div id="quiz-container" class="transition-all duration-300">
            <p class="text-center text-gray-500 italic">Please select a subject above to load questions.</p>
        </div>
    </div>

    <script>
        // FIX: Hardcode the API base to the local Flask server address (127.0.0.1:5000).
        // The previous code failed because the frontend (Netlify) tried to reach the API 
        // on its own domain, where the Python server is not running.
        const API_BASE = 'https://quizelet-ritzz.onrender.com/api';
        let currentSubject = '';
        let currentQuizData = [];
 // Store the fetched questions

        document.addEventListener('DOMContentLoaded', () => {
            fetchSubjects();
        });

        // 1. Fetch and display list of subjects
        function fetchSubjects() {
            fetch(API_BASE + '/subjects')
                .then(response => {
                    if (!response.ok) {
                        // Check if the server is up but returned an error (e.g., 404)
                        throw new Error(`API returned status ${response.status}. Is Flask running?`);
                    }
                    // Crucial: Handle potential non-JSON responses (like HTML error pages)
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.includes("application/json")) {
                        return response.json();
                    } else {
                        // If it's not JSON, assume the server is down or the endpoint is wrong
                        throw new Error("Received non-JSON response. Check Flask logs.");
                    }
                })
                .then(subjects => {
                    const buttonContainer = document.getElementById('subject-buttons');
                    buttonContainer.innerHTML = ''; 
                    
                    subjects.forEach(subject => {
                        const button = document.createElement('button');
                        button.textContent = subject.toUpperCase();
                        // Tailwind classes for styling buttons
                        button.className = "px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out";
                        
                        button.onclick = () => {
                            // Reset button styles
                            document.querySelectorAll('#subject-buttons button').forEach(btn => {
                                btn.classList.remove('ring-4', 'ring-indigo-300');
                            });
                            // Highlight selected button
                            button.classList.add('ring-4', 'ring-indigo-300');
                            fetchQuiz(subject);
                        };
                        buttonContainer.appendChild(button);
                    });
                })
                .catch(error => {
                    document.getElementById('quiz-container').innerHTML = `<p class="text-red-500">Error fetching subjects: ${error.message}. Please ensure your Flask server is running at ${API_BASE.replace('/api', '')}.</p>`;
                });
        }

        // 2. Fetch and store a specific quiz (without answers)
        function fetchQuiz(subject) {
            currentSubject = subject;
            const container = document.getElementById('quiz-container');
            container.innerHTML = `<h2 class="text-xl font-semibold text-center text-indigo-600">Loading ${subject.toUpperCase()} Quiz...</h2>`;

            fetch(`${API_BASE}/quiz/${subject}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Subject not found or API error.');
                    }
                    return response.json();
                })
                .then(quiz => {
                    currentQuizData = quiz; // Store the questions
                    displayQuiz(subject, quiz);
                })
                .catch(error => {
                    container.innerHTML = `<p class="text-red-500 text-center">Error: ${error.message}</p>`;
                });
        }

        // 3. Render the quiz questions with radio buttons
        function displayQuiz(subject, quiz) {
            const container = document.getElementById('quiz-container');
            let html = `<h2 class="text-2xl font-bold text-gray-700 mb-6">${subject.toUpperCase()} Quiz Questions (${quiz.length} total)</h2>`;
            
            quiz.forEach((q, index) => {
                html += `
                    <div id="q-${q.id}" class="question bg-gray-50 p-4 mb-6 rounded-lg shadow-sm border border-gray-200">
                        <p class="text-lg font-semibold text-gray-800 mb-3">Question ${index + 1}: ${q.question}</p>
                        
                        <div class="options space-y-2 mb-4">
                            ${q.options.map((option, optIndex) => `
                                <label class="block text-gray-700 cursor-pointer hover:bg-indigo-50 p-2 rounded transition-colors duration-100">
                                    <input type="radio" name="answer-q-${q.id}" value="${option}" class="mr-2 accent-indigo-600">
                                    ${option}
                                </label>
                            `).join('')}
                        </div>
                        
                        <button 
                            onclick="checkUserAnswer('${currentSubject}', ${q.id})" 
                            class="check-button px-4 py-2 bg-green-500 text-white font-medium rounded-lg hover:bg-green-600 transition duration-150 ease-in-out"
                        >
                            Check Answer
                        </button>
                        
                        <div id="result-${q.id}" class="mt-3 font-semibold text-sm"></div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
        
        // 4. Check the user's answer using the API
        function checkUserAnswer(subject, questionId) {
            const resultDiv = document.getElementById(`result-${questionId}`);
            const checkButton = document.querySelector(`#q-${questionId} .check-button`);
            const selectedRadio = document.querySelector(`input[name="answer-q-${questionId}"]:checked`);
            
            if (!selectedRadio) {
                resultDiv.innerHTML = `<span class="text-red-500">Please select an option first.</span>`;
                return;
            }
            
            const userAnswer = selectedRadio.value;
            
            // Disable button and show loading
            checkButton.disabled = true;
            checkButton.textContent = 'Checking...';
            
            // Note: We use POST to check the answer
            fetch(`${API_BASE}/check_answer/${subject}/${questionId}?answer=${encodeURIComponent(userAnswer)}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                checkButton.disabled = false;
                checkButton.textContent = 'Check Answer';

                if (data.is_correct) {
                    resultDiv.innerHTML = `<span class="text-green-600">✅ Correct! Great job!</span>`;
                    document.getElementById(`q-${questionId}`).classList.add('bg-green-100');
                    checkButton.style.display = 'none'; // Hide button after correct answer
                } else {
                    resultDiv.innerHTML = `<span class="text-red-600">❌ Incorrect. The correct answer was: <strong>${data.correct_answer}</strong></span>`;
                    document.getElementById(`q-${questionId}`).classList.add('bg-red-100');
                }
            })
            .catch(error => {
                checkButton.disabled = false;
                checkButton.textContent = 'Check Answer';
                resultDiv.innerHTML = `<span class="text-red-500">Error checking answer: ${error.message}</span>`;
            });
        }
    </script>
</body>
</html>
